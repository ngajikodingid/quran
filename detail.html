<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baca Al-Qur'an - Mushaf Digital</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Amiri+Quran&family=Noto+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root { --primary-color: #2E7D32; --background-color: #F8F9FA; --surface-color: #FFFFFF; --text-color: #212529; --border-color: #E9ECEF; --font-latin: 'Poppins', 'Noto Sans', sans-serif; --font-arabic: 'Amiri Quran', serif; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-latin); background-color: var(--background-color); margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--surface-color); border-radius: 16px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08); overflow: hidden; }
        .sticky-bar { position: sticky; background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); z-index: 10; padding: 15px 20px; }
        .page-header { top: 0; border-bottom: 1px solid var(--border-color); }
        .page-footer { bottom: 0; border-top: 1px solid var(--border-color); }
        .header-top { display: flex; align-items: center; justify-content: space-between; }
        .header-info { display: flex; align-items: center; }
        .back-button { margin-right: 15px; font-size: 20px; color: var(--text-color); text-decoration: none; }
        #view-title { font-size: 18px; font-weight: 600; color: var(--primary-color); }
        #juz-info { font-size: 14px; color: #6c757d; }
        .header-actions button { background: none; border: none; font-size: 18px; color: var(--subtle-text-color); cursor: pointer; padding: 5px; }
        .header-actions button.active { color: var(--primary-color); }
        #loader { text-align: center; padding: 80px 0; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); margin: 0 auto 15px; animation: spin 1s ease infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .content { padding: 0 10px 20px 10px; }
        /* --- HEADER SURAH BARU --- */
        .surah-header-card { text-align: center; padding: 30px 20px; margin: 20px 10px; border-radius: 12px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border: 1px solid var(--border-color); }
        #surah-name-arabic { font-family: var(--font-arabic); font-size: 36px; color: var(--primary-color); }
        #surah-name-latin { font-size: 24px; font-weight: 600; margin: 5px 0; }
        #surah-details { font-size: 14px; color: #6c757d; text-transform: uppercase; }
        .bismillah-header { font-family: var(--font-arabic); text-align: center; font-size: 24px; padding: 25px 0; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); margin: 20px 0; }
        .verse-item { padding: 25px 0; border-bottom: 1px solid var(--border-color); } .verse-item:last-child { border-bottom: none; }
        .verse-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        /* --- NOMOR AYAT KALIGRAFI BARU --- */
        .verse-number-wrapper { width: 40px; height: 40px; background-image: url('https://i.ibb.co/9hNn2y1/ayat-bg.png'); background-size: contain; background-repeat: no-repeat; display: flex; align-items: center; justify-content: center; font-family: var(--font-arabic); font-size: 16px; color: var(--primary-color); }
        .arabic-text { font-family: var(--font-arabic); font-size: 30px; text-align: right; direction: rtl; line-height: 2.2; margin-bottom: 16px; }
        .translation-text { font-size: 15px; line-height: 1.7; color: #444; margin-top: 20px; padding-left: 55px; } .translation-text.hidden { display: none; }
        /* --- MENU TIGA TITIK BARU --- */
        .verse-menu-button { background: none; border: none; font-size: 18px; color: #aaa; cursor: pointer; padding: 10px; }
        .verse-menu-popup { display: none; position: absolute; background-color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 20; border: 1px solid var(--border-color); overflow: hidden; }
        .verse-menu-popup a { display: block; padding: 12px 18px; text-decoration: none; color: var(--text-color); font-size: 14px; }
        .verse-menu-popup a i { margin-right: 12px; width: 16px; text-align: center; color: var(--subtle-text-color); }
        .verse-menu-popup a:hover { background-color: #f8f9fa; }
        .page-navigation { display: flex; justify-content: space-between; align-items: center; }
        .nav-button { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; }
        .nav-button:disabled { background-color: #ccc; cursor: not-allowed; }
        #page-number-input { width: 50px; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; text-align: center; font-size: 14px; }
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; } .modal.active { display: flex; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; position: relative; animation: slide-down 0.3s ease-out; }
        @keyframes slide-down { from { transform: translateY(-30px); } to { transform: translateY(0); } }
        .modal-close { position: absolute; top: 15px; right: 20px; color: #aaa; font-size: 28px; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <header class="page-header sticky-bar">
        <div class="header-top">
            <div class="header-info">
                <a href="home.html" class="back-button"><i class="fas fa-arrow-left"></i></a>
                <div><h1 id="view-title">Memuat...</h1><div id="juz-info"></div></div>
            </div>
            <div class="header-actions">
                <button id="toggle-translation" class="active" title="Tampilkan/Sembunyikan Terjemahan"><i class="fas fa-book"></i></button>
            </div>
        </div>
    </header>
    <main>
        <div id="loader"><div class="spinner"></div><span>Memuat data halaman...</span></div>
        <div class="content" id="verse-container" style="display: none;"></div>
    </main>
    <footer class="page-footer sticky-bar">
        <div class="page-navigation">
            <button id="prev-page-btn" class="nav-button">Sebelumnya</button>
            <input type="number" id="page-number-input" min="1" max="604">
            <button id="next-page-btn" class="nav-button">Berikutnya</button>
        </div>
    </footer>
</div>
<div id="tafsir-modal" class="modal">
    <div class="modal-content"><span class="modal-close">&times;</span><h3 id="tafsir-title"></h3><p id="tafsir-text"></p></div>
</div>
<div class="verse-menu-popup" id="verse-menu">
    <a href="#" id="menu-play-audio"><i class="fas fa-play"></i> Putar Ayat</a>
    <a href="#" id="menu-show-tafsir"><i class="fas fa-book-open"></i> Lihat Tafsir</a>
    <a href="#" id="menu-bookmark"><i class="far fa-star"></i> Simpan ke Bookmark</a>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASE_URL = 'https://api.quran.com/api/v4';
    const viewTitle = document.getElementById('view-title');
    const juzInfo = document.getElementById('juz-info');
    const verseContainer = document.getElementById('verse-container');
    const loader = document.getElementById('loader');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    const pageInput = document.getElementById('page-number-input');
    const translationBtn = document.getElementById('toggle-translation');
    const modal = document.getElementById('tafsir-modal');
    const verseMenu = document.getElementById('verse-menu');
    let currentPage = 1;
    let chaptersData = null;
    let pageDataCache = {};
    let currentAudio = null;
    let bookmarks = JSON.parse(localStorage.getItem('quranBookmarksV2')) || [];

    const getUrlParameter = (name) => new URL(window.location.href).searchParams.get(name);

    const fetchAndDisplayPage = async (pageNumber) => {
        if (!pageNumber || pageNumber < 1 || pageNumber > 604) return;
        currentPage = parseInt(pageNumber);
        verseContainer.style.display = 'none';
        loader.style.display = 'block';
        if (location.hash) { history.pushState("", document.title, window.location.pathname + window.location.search); }
        window.scrollTo(0, 0);

        if (pageDataCache[currentPage]) {
            displayPageContent(pageDataCache[currentPage]);
            updateNavigation();
            return;
        }

        const params = new URLSearchParams({ language: 'id', translations: 33, tafsirs: 167, audio: 7, fields: 'text_uthmani' });
        try {
            const response = await fetch(`${API_BASE_URL}/verses/by_page/${currentPage}?${params}`);
            if (!response.ok) throw new Error(`Network response error: ${response.status}`);
            const data = await response.json();
            pageDataCache[currentPage] = data.verses;
            displayPageContent(data.verses);
            updateNavigation();
        } catch (error) {
            verseContainer.innerHTML = `<p style='text-align:center;'>Gagal memuat halaman. Coba refresh.</p>`;
            console.error("Fetch Error:", error);
        } finally {
            verseContainer.style.display = 'block';
            loader.style.display = 'none';
        }
    };

    const displayPageContent = async (verses) => {
        if (!verses || !verses.length) return;
        verseContainer.innerHTML = '';
        const firstVerse = verses[0];
        const surahOnPage = chaptersData.find(c => c.id === firstVerse.chapter_id);

        if (firstVerse.verse_number === 1) {
            verseContainer.innerHTML += displaySurahHeader(surahOnPage);
            if (surahOnPage.bismillah_pre) {
                verseContainer.innerHTML += `<div class="bismillah-header">بِسْمِ ٱللَّهِ ٱلرَّحْمَـٰنِ ٱلرَّحِيمِ</div>`;
            }
        }
        
        const surahIds = [...new Set(verses.map(v => v.chapter_id))];
        viewTitle.textContent = surahIds.map(id => chaptersData.find(c => c.id == id)?.name_simple || '').join(' & ');
        juzInfo.textContent = `Juz ${firstVerse.juz_number}`;
        
        verses.forEach(verse => {
            const verseNumberArabic = new Intl.NumberFormat('ar-EG').format(verse.verse_number);
            verseContainer.innerHTML += `
                <div class="verse-item" id="${verse.verse_key}">
                    <div class="verse-header">
                        <button class="verse-menu-button" data-verse-key="${verse.verse_key}"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="verse-number-wrapper">${verseNumberArabic}</div>
                    </div>
                    <p class="arabic-text">${verse.text_uthmani}</p>
                    <p class="translation-text">${verse.translations[0].text.replace(/<[^>]*>/g, '')}</p>
                </div>`;
        });
        attachActionListeners();
        setInitialTranslationVisibility();
        const hash = window.location.hash.substring(1);
        if (hash) document.getElementById(hash)?.scrollIntoView();
    };

    const displaySurahHeader = (surahInfo) => {
        return `
            <div class="surah-header-card">
                <div id="surah-name-arabic">${surahInfo.name_arabic}</div>
                <div id="surah-name-latin">${surahInfo.name_simple}</div>
                <div id="surah-details">${surahInfo.revelation_place} • ${surahInfo.verses_count} AYAT</div>
            </div>`;
    };

    const attachActionListeners = () => {
        document.querySelectorAll('.verse-menu-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const verseKey = e.currentTarget.dataset.verseKey;
                openVerseMenu(e.currentTarget, verseKey);
            });
        });
    };
    
    const openVerseMenu = (button, verseKey) => {
        const verse = pageDataCache[currentPage].find(v => v.verse_key === verseKey);
        if (!verse) return;
        
        // Atur aksi untuk setiap menu
        document.getElementById('menu-play-audio').onclick = (e) => { e.preventDefault(); handleAudio(verse.audio.url); verseMenu.style.display = 'none'; };
        document.getElementById('menu-show-tafsir').onclick = (e) => { e.preventDefault(); openTafsirModal(verse); verseMenu.style.display = 'none'; };
        
        const bookmarkLink = document.getElementById('menu-bookmark');
        const isBookmarked = bookmarks.includes(verseKey);
        bookmarkLink.innerHTML = isBookmarked ? '<i class="fas fa-star"></i> Hapus Bookmark' : '<i class="far fa-star"></i> Simpan Bookmark';
        bookmarkLink.onclick = (e) => { e.preventDefault(); toggleBookmark(verseKey); verseMenu.style.display = 'none'; };

        // Tampilkan menu
        const rect = button.getBoundingClientRect();
        verseMenu.style.display = 'block';
        verseMenu.style.top = `${window.scrollY + rect.bottom}px`;
        verseMenu.style.left = `${rect.left - verseMenu.offsetWidth + rect.width}px`;
    };

    const handleAudio = (audioUrl) => {
        if (currentAudio && !currentAudio.paused) { currentAudio.pause(); }
        if (currentAudio && currentAudio.src.includes(audioUrl)) {
            currentAudio = null; return;
        }
        currentAudio = new Audio(`https://verses.quran.com/${audioUrl}`);
        currentAudio.play();
        currentAudio.onended = () => { currentAudio = null; };
    };

    const openTafsirModal = (verse) => {
        const surahName = chaptersData.find(c => c.id == verse.chapter_id)?.name_simple || '';
        const tafsirContent = verse.tafsirs && verse.tafsirs.length > 0 ? verse.tafsirs[0].text : "Tafsir tidak tersedia untuk ayat ini.";
        modal.querySelector('#tafsir-title').textContent = `Tafsir ${surahName} Ayat ${verse.verse_number}`;
        modal.querySelector('#tafsir-text').innerHTML = tafsirContent;
        modal.classList.add('active');
    };

    const toggleBookmark = (verseKey) => {
        const index = bookmarks.indexOf(verseKey);
        if (index > -1) bookmarks.splice(index, 1);
        else bookmarks.push(verseKey);
        localStorage.setItem('quranBookmarksV2', JSON.stringify(bookmarks));
    };

    const toggleAllTranslations = () => {
        translationBtn.classList.toggle('active');
        const show = translationBtn.classList.contains('active');
        document.querySelectorAll('.translation-text').forEach(el => el.classList.toggle('hidden', !show));
    };
    
    const setInitialTranslationVisibility = () => {
        const show = translationBtn.classList.contains('active');
        document.querySelectorAll('.translation-text').forEach(el => el.classList.toggle('hidden', !show));
    };

    const updateNavigation = () => {
        pageInput.value = currentPage;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= 604;
    };
    
    const initializePage = async () => {
        try {
            const res = await fetch(`${API_BASE_URL}/chapters?language=id`);
            if (!res.ok) throw new Error('Gagal mengambil daftar surah');
            chaptersData = (await res.json()).chapters;
            const surahId = getUrlParameter('surah');
            const juzId = getUrlParameter('juz');
            let startPage = 1;
            if (surahId) {
                const surahInfo = chaptersData.find(c => c.id == surahId);
                startPage = surahInfo ? surahInfo.pages[0] : 1;
            } else if (juzId) {
                const resJuz = await fetch(`${API_BASE_URL}/juzs/${juzId}`);
                if (!resJuz.ok) throw new Error('Gagal mengambil data juz');
                const juzData = (await resJuz.json()).juz;
                const startingSurah = Object.keys(juzData.verse_mapping)[0];
                const ayatRange = juzData.verse_mapping[startingSurah];
                const startingAyat = ayatRange.split('-')[0];
                const fullVerseKey = `${startingSurah}:${startingAyat}`;
                const resVerse = await fetch(`${API_BASE_URL}/verses/by_key/${fullVerseKey}?fields=page_number`);
                if (!resVerse.ok) throw new Error('Gagal mengambil data halaman ayat');
                startPage = (await resVerse.json()).verse.page_number;
            }
            fetchAndDisplayPage(startPage);
        } catch (error) {
            loader.innerHTML = `Gagal memuat data awal.<br><small>${error.message}</small>`;
            console.error("Initialization Error:", error);
        }
    };
    
    prevBtn.onclick = () => fetchAndDisplayPage(currentPage - 1);
    nextBtn.onclick = () => fetchAndDisplayPage(currentPage + 1);
    pageInput.onchange = () => fetchAndDisplayPage(pageInput.value);
    translationBtn.onclick = toggleAllTranslations;
    modal.querySelector('.modal-close').onclick = () => modal.classList.remove('active');
    document.addEventListener('click', (e) => { // Sembunyikan menu jika klik di luar
        if (!verseMenu.contains(e.target) && !e.target.closest('.verse-menu-button')) {
            verseMenu.style.display = 'none';
        }
    });

    initializePage();
});
</script>
</body>
</html>
