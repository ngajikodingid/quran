<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baca Al-Qur'an - Mushaf Digital</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Amiri+Quran&family=Noto+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #2E7D32; --background-color: #F8F9FA; --surface-color: #FFFFFF;
            --text-color: #212529; --subtle-text-color: #6c757d; --border-color: #E9ECEF;
            --font-latin: 'Poppins', 'Noto Sans', sans-serif; --font-arabic: 'Amiri Quran', serif;
            --shadow-color: rgba(0, 0, 0, 0.08);
        }
        body.dark-mode {
            --primary-color: #66bb6a; --background-color: #121212; --surface-color: #1e1e1e;
            --text-color: #e0e0e0; --subtle-text-color: #9e9e9e; --border-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-latin); background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 15px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--surface-color); border-radius: 16px; box-shadow: 0 8px 30px var(--shadow-color); overflow: hidden; transition: background-color 0.3s; }
        .sticky-bar { position: sticky; background-color: color-mix(in srgb, var(--surface-color) 95%, transparent); backdrop-filter: blur(8px); z-index: 10; padding: 15px 20px; transition: background-color 0.3s, border-color 0.3s; }
        .page-header { top: 0; border-bottom: 1px solid var(--border-color); }
        .page-footer { bottom: 0; border-top: 1px solid var(--border-color); }
        .header-top { display: flex; align-items: center; justify-content: space-between; }
        .header-info { display: flex; align-items: center; }
        .back-button { margin-right: 15px; font-size: 20px; color: var(--text-color); text-decoration: none; }
        #view-title { font-size: 18px; font-weight: 600; color: var(--primary-color); }
        #juz-info { font-size: 14px; color: var(--subtle-text-color); }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .header-actions button { background: none; border: none; font-size: 18px; color: var(--subtle-text-color); cursor: pointer; padding: 5px; }
        .header-actions button.active { color: var(--primary-color); }
        .surah-navigation { display: flex; justify-content: space-between; align-items: center; padding-top: 15px; }
        .surah-nav-button { display: flex; align-items: center; gap: 8px; background-color: var(--background-color); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 20px; text-decoration: none; color: var(--text-color); font-size: 14px; font-weight: 500; }
        .surah-nav-button.disabled { opacity: 0.5; pointer-events: none; }
        .surah-nav-selects { display: flex; gap: 10px; }
        .nav-select { padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-color); font-family: var(--font-latin); font-size: 14px; }
        #loader { text-align: center; padding: 80px 0; }
        .spinner { border: 4px solid rgba(128,128,128,0.2); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); margin: 0 auto 15px; animation: spin 1s ease infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .content { padding: 0 10px 20px 10px; }
        .surah-separator { text-align: center; padding: 30px 20px; margin: 20px 10px; }
        .surah-separator .surah-title-prefix { font-family: var(--font-arabic); font-size: 24px; color: var(--primary-color); }
        .surah-separator .arabic-name { font-family: var(--font-arabic); font-size: 36px; color: var(--primary-color); margin-top: -15px; }
        .surah-separator .latin-name { font-size: 24px; font-weight: 600; margin: 5px 0; }
        .surah-separator .details { font-size: 14px; color: var(--subtle-text-color); text-transform: uppercase; }
        .bismillah-header { font-family: var(--font-arabic); text-align: center; font-size: 24px; padding: 25px 0; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); margin: 20px 0; }
        .verse-item { padding: 25px 0; border-bottom: 1px solid var(--border-color); position: relative; } .verse-item:last-child { border-bottom: none; }
        .verse-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .verse-number-wrapper { width: 40px; height: 40px; background-image: url('https://i.ibb.co/9hNn2y1/ayat-bg.png'); background-size: contain; background-repeat: no-repeat; display: flex; align-items: center; justify-content: center; font-family: var(--font-arabic); font-size: 16px; color: var(--primary-color); }
        .arabic-text { font-family: var(--font-arabic); text-align: right; direction: rtl; margin-bottom: 16px; transition: font-size 0.3s, line-height 0.3s; }
        .font-size-small .arabic-text { font-size: 26px; line-height: 2.0; }
        .font-size-medium .arabic-text { font-size: 30px; line-height: 2.2; }
        .font-size-large .arabic-text { font-size: 34px; line-height: 2.4; }
        .font-size-xl .arabic-text { font-size: 38px; line-height: 2.6; }
        .translation-text { font-size: 15px; line-height: 1.7; color: var(--subtle-text-color); margin-top: 20px; padding-left: 55px; } .translation-text.hidden { display: none; }
        .verse-menu-button { background: none; border: none; font-size: 18px; color: #aaa; cursor: pointer; padding: 10px; position: absolute; top: 15px; left: 0; }
        .verse-menu-popup { display: none; position: absolute; background-color: var(--surface-color); border-radius: 8px; box-shadow: 0 4px 15px var(--shadow-color); z-index: 20; border: 1px solid var(--border-color); overflow: hidden; }
        .verse-menu-popup a { display: flex; align-items: center; padding: 12px 18px; text-decoration: none; color: var(--text-color); font-size: 14px; white-space: nowrap; }
        .verse-menu-popup a i { margin-right: 12px; width: 16px; text-align: center; color: var(--subtle-text-color); }
        .verse-menu-popup a:hover { background-color: var(--background-color); }
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; } .modal.active { display: flex; }
        .modal-content { background-color: var(--surface-color); padding: 0; border-radius: 12px; width: 90%; max-width: 600px; position: relative; animation: slide-down 0.3s ease-out; display: flex; flex-direction: column; max-height: 80vh; }
        @keyframes slide-down { from { transform: translateY(-30px); } to { transform: translateY(0); } }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 18px; }
        .modal-body { padding: 25px; overflow-y: auto; }
        .modal-close { font-size: 28px; cursor: pointer; color: #aaa; }
        #tafsir-select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--background-color); color: var(--text-color); }
        .tafsir-content.arabic { font-family: var(--font-arabic); direction: rtl; text-align: right; font-size: 18px; line-height: 1.8; }
        #theme-toggle .fa-moon { display: none; }
        body.dark-mode #theme-toggle .fa-moon { display: inline; }
        body.dark-mode #theme-toggle .fa-sun { display: none; }
        .page-navigation { display: flex; justify-content: space-between; align-items: center; }
        .nav-button { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; }
        .nav-button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body class="font-size-medium">
<div class="container">
    <header class="page-header sticky-bar">
        <div class="header-top">
            <div class="header-info">
                <a href="home.html" class="back-button"><i class="fas fa-arrow-left"></i></a>
                <div><h1 id="view-title">Memuat...</h1><div id="juz-info"></div></div>
            </div>
            <div class="header-actions">
                <button id="toggle-translation" class="active" title="Tampilkan/Sembunyikan Terjemahan"><i class="fas fa-language"></i></button>
                <button id="font-size-toggle" title="Ubah Ukuran Font"><i class="fas fa-font"></i></button>
                <button id="theme-toggle" title="Ubah Tema"><i class="fas fa-sun"></i><i class="fas fa-moon"></i></button>
            </div>
        </div>
        <div class="surah-navigation">
            <a href="#" id="prev-surah-btn" class="surah-nav-button"><i class="fas fa-chevron-left"></i> <span></span></a>
            <div class="surah-nav-selects">
                <select id="surah-select" class="nav-select"></select>
                <select id="page-select" class="nav-select"></select>
            </div>
            <a href="#" id="next-surah-btn" class="surah-nav-button"><span></span> <i class="fas fa-chevron-right"></i></a>
        </div>
    </header>
    <main>
        <div id="loader"><div class="spinner"></div><span>Memuat data halaman...</span></div>
        <div class="content" id="verse-container" style="display: none;"></div>
    </main>
    <footer class="page-footer sticky-bar">
        <div class="page-navigation">
            <button id="prev-page-btn" class="nav-button">Sebelumnya</button>
            <button id="next-page-btn" class="nav-button">Berikutnya</button>
        </div>
    </footer>
</div>
<div id="tafsir-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="tafsir-title"></h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <select id="tafsir-select"></select>
            <div id="tafsir-content" class="tafsir-content"></div>
        </div>
    </div>
</div>
<div class="verse-menu-popup" id="verse-menu">
    <a href="#" id="menu-play-audio"><i class="fas fa-play"></i> Putar Ayat</a>
    <a href="#" id="menu-show-tafsir"><i class="fas fa-book-open"></i> Lihat Tafsir</a>
    <a href="#" id="menu-bookmark"><i class="far fa-star"></i> Simpan ke Bookmark</a>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const QURAN_API_URL = 'https://api.quran.com/api/v4';
    const body = document.body;
    const viewTitle = document.getElementById('view-title');
    const juzInfo = document.getElementById('juz-info');
    const verseContainer = document.getElementById('verse-container');
    const loader = document.getElementById('loader');
    const translationBtn = document.getElementById('toggle-translation');
    const themeToggleBtn = document.getElementById('theme-toggle');
    const fontSizeBtn = document.getElementById('font-size-toggle');
    const modal = document.getElementById('tafsir-modal');
    const verseMenu = document.getElementById('verse-menu');
    const prevSurahBtn = document.getElementById('prev-surah-btn');
    const nextSurahBtn = document.getElementById('next-surah-btn');
    const surahSelect = document.getElementById('surah-select');
    const pageSelect = document.getElementById('page-select');
    const prevPageBtn = document.getElementById('prev-page-btn');
    const nextPageBtn = document.getElementById('next-page-btn');
    let currentPage = 1;
    let chaptersData = null;
    let pageDataCache = {};
    let tafsirCache = {};
    let currentAudio = null;
    let bookmarks = JSON.parse(localStorage.getItem('quranBookmarksV2')) || [];
    const fontSizes = ['medium', 'large', 'xl', 'small'];
    let currentSizeIndex = 0;
    
    // --- DAFTAR TAFSIR BARU ---
    const availableTafsirs = [
        { id: 167, name: 'Kemenag (Ringkas)', lang: 'id' },
        { id: 168, name: 'Kemenag (Lengkap)', lang: 'id' },
        { id: 161, name: 'Al-Jalalayn', lang: 'ar' },
        { id: 16,  name: 'Al-Muyassar', lang: 'ar' },
        { id: 91,  name: 'As-Sa\'di', lang: 'ar' },
        { id: 14,  name: 'Ibn Kathir', lang: 'ar' },
        { id: 15,  name: 'At-Tabari', lang: 'ar' },
    ];

    const getUrlParameter = (name) => new URL(window.location.href).searchParams.get(name);

    const fetchAndDisplayPage = async (pageNumber, keepPosition = false) => {
        // ... (fungsi ini tidak berubah) ...
    };

    const displayPageContent = (verses) => {
        // ... (fungsi ini tidak berubah) ...
    };

    const displaySurahHeader = (surahInfo) => { /* ... (fungsi ini tidak berubah) ... */ };
    
    const attachActionListeners = () => {
        document.querySelectorAll('.verse-menu-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                openVerseMenu(e.currentTarget, e.currentTarget.dataset.verseKey);
            });
        });
    };
    
    // --- PERBAIKAN UTAMA: Posisi Menu Tiga Titik ---
    const openVerseMenu = (button, verseKey) => {
        document.getElementById('menu-play-audio').onclick = (e) => { e.preventDefault(); handleAudio(verseKey); verseMenu.style.display = 'none'; };
        document.getElementById('menu-show-tafsir').onclick = (e) => { e.preventDefault(); openTafsirModal(verseKey); verseMenu.style.display = 'none'; };
        const bookmarkLink = document.getElementById('menu-bookmark');
        const isBookmarked = bookmarks.includes(verseKey);
        bookmarkLink.innerHTML = isBookmarked ? `<i class="fas fa-star"></i> Hapus Bookmark` : `<i class="far fa-star"></i> Simpan Bookmark`;
        bookmarkLink.onclick = (e) => { e.preventDefault(); toggleBookmark(verseKey); verseMenu.style.display = 'none'; };
        
        const rect = button.getBoundingClientRect();
        verseMenu.style.display = 'block';
        verseMenu.style.top = `${button.offsetTop + rect.height}px`;

        // Logika dinamis untuk posisi horizontal
        if ((rect.left + verseMenu.offsetWidth) > window.innerWidth) {
            verseMenu.style.left = 'auto';
            verseMenu.style.right = `${window.innerWidth - (rect.left + rect.width)}px`; // Buka dari kanan ke kiri
        } else {
            verseMenu.style.left = `${button.offsetLeft}px`; // Buka dari kiri ke kanan
            verseMenu.style.right = 'auto';
        }
    };

    const handleAudio = (verseKey) => {
        const verse = pageDataCache[currentPage].find(v => v.verse_key === verseKey);
        if (!verse || !verse.audio?.url) return;
        const fullUrl = `https://verses.quran.com/${verse.audio.url}`;
        if (currentAudio && !currentAudio.paused) {
            currentAudio.pause();
            if (currentAudio.src === fullUrl) { currentAudio = null; return; }
        }
        currentAudio = new Audio(fullUrl);
        currentAudio.play();
        currentAudio.onended = () => { currentAudio = null; };
    };

    // --- PERBAIKAN UTAMA: Logika Tafsir dengan Dropdown ---
    const openTafsirModal = (verseKey) => {
        const [surahNum, ayatNum] = verseKey.split(':');
        const surahInfo = chaptersData.find(c => c.id == surahNum);
        if (!surahInfo) return;

        const modalTitle = modal.querySelector('#tafsir-title');
        const tafsirSelect = modal.querySelector('#tafsir-select');
        
        modalTitle.textContent = `Tafsir ${surahInfo.name_simple} Ayat ${ayatNum}`;
        
        // Isi dropdown
        tafsirSelect.innerHTML = availableTafsirs.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        
        // Tambah event listener untuk dropdown
        tafsirSelect.onchange = () => {
            fetchAndDisplayTafsir(verseKey, tafsirSelect.value);
        };

        // Langsung muat tafsir pertama (default)
        fetchAndDisplayTafsir(verseKey, tafsirSelect.value);

        modal.classList.add('active');
    };

    const fetchAndDisplayTafsir = async (verseKey, tafsirId) => {
        const tafsirContent = modal.querySelector('#tafsir-content');
        tafsirContent.innerHTML = '<i>Memuat tafsir...</i>';
        
        const selectedTafsir = availableTafsirs.find(t => t.id == tafsirId);
        tafsirContent.classList.toggle('arabic', selectedTafsir.lang === 'ar');

        // Cek Cache
        if (tafsirCache[verseKey] && tafsirCache[verseKey][tafsirId]) {
            tafsirContent.innerHTML = tafsirCache[verseKey][tafsirId];
            return;
        }

        try {
            const response = await fetch(`${QURAN_API_URL}/tafsirs/${tafsirId}/by_verse/${verseKey}`);
            if (!response.ok) throw new Error('Gagal mengambil data tafsir');
            const json = await response.json();
            const text = json.tafsir.text;

            // Simpan ke Cache
            if (!tafsirCache[verseKey]) tafsirCache[verseKey] = {};
            tafsirCache[verseKey][tafsirId] = text;
            
            tafsirContent.innerHTML = text;
        } catch (error) {
            tafsirContent.innerHTML = `Gagal memuat tafsir. ${error.message}`;
            console.error("Tafsir fetch error:", error);
        }
    };
    
    // ... (sisa fungsi-fungsi lain tidak ada perubahan)
    const toggleBookmark = (verseKey) => { /* ... */ };
    const toggleAllTranslations = () => { /* ... */ };
    const setInitialTranslationVisibility = () => { /* ... */ };
    const setTheme = (theme) => { /* ... */ };
    const setFontSize = (sizeClass) => { /* ... */ };
    const cycleFontSize = () => { /* ... */ };
    const populateNavControls = () => { /* ... */ };
    const updateSurahNavigation = (currentSurahId) => { /* ... */ };
    
    const initializePage = async () => {
        try {
            const res = await fetch(`${QURAN_API_URL}/chapters?language=id`);
            if (!res.ok) throw new Error('Gagal mengambil daftar surah');
            chaptersData = (await res.json()).chapters;
            populateNavControls();
            const surahId = getUrlParameter('surah');
            const juzId = getUrlParameter('juz');
            let startPage = 1;
            if (surahId) {
                const surahInfo = chaptersData.find(c => c.id == surahId);
                startPage = surahInfo ? surahInfo.pages[0] : 1;
            } else if (juzId) {
                const resJuz = await fetch(`${QURAN_API_URL}/juzs/${juzId}`);
                if (!resJuz.ok) throw new Error('Gagal mengambil data juz');
                const juzData = (await resJuz.json()).juz;
                const startingSurah = Object.keys(juzData.verse_mapping)[0];
                const ayatRange = juzData.verse_mapping[startingSurah];
                const startingAyat = ayatRange.split('-')[0];
                const fullVerseKey = `${startingSurah}:${startingAyat}`;
                const resVerse = await fetch(`${QURAN_API_URL}/verses/by_key/${fullVerseKey}?fields=page_number,chapter_id`);
                if (!resVerse.ok) throw new Error('Gagal mengambil data halaman ayat');
                const verseData = (await resVerse.json()).verse;
                startPage = verseData.page_number;
            }
            fetchAndDisplayPage(startPage);
        } catch (error) {
            loader.innerHTML = `Gagal memuat data awal.<br><small>${error.message}</small>`;
        }
    };
    
    surahSelect.onchange = () => { window.location.href = `detail.html?surah=${surahSelect.value}`; };
    pageSelect.onchange = () => { fetchAndDisplayPage(pageSelect.value); };
    translationBtn.onclick = toggleAllTranslations;
    fontSizeBtn.onclick = cycleFontSize;
    themeToggleBtn.onclick = () => setTheme(body.classList.contains('dark-mode') ? 'light' : 'dark');
    modal.querySelector('.modal-close').onclick = () => modal.classList.remove('active');
    document.addEventListener('click', (e) => {
        if (!verseMenu.contains(e.target) && !e.target.closest('.verse-menu-button')) {
            verseMenu.style.display = 'none';
        }
    });
    prevPageBtn.onclick = () => fetchAndDisplayPage(currentPage - 1);
    nextPageBtn.onclick = () => fetchAndDisplayPage(currentPage + 1);
    
    const savedTheme = localStorage.getItem('quranTheme') || 'light';
    const savedFontSize = localStorage.getItem('quranFontSize') || 'medium';
    setTheme(savedTheme);
    setFontSize(savedFontSize);

    initializePage();
});
</script>
</body>
</html>
