<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baca Al-Qur'an - Mushaf Digital</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Amiri+Quran&family=Noto+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #2E7D32; --background-color: #F8F9FA; --surface-color: #FFFFFF;
            --text-color: #212529; --subtle-text-color: #6c757d; --border-color: #E9ECEF;
            --font-latin: 'Poppins', 'Noto Sans', sans-serif; --font-arabic: 'Amiri Quran', serif;
            --shadow-color: rgba(0, 0, 0, 0.08);
        }
        body.dark-mode {
            --primary-color: #66bb6a; --background-color: #121212; --surface-color: #1e1e1e;
            --text-color: #e0e0e0; --subtle-text-color: #9e9e9e; --border-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-latin); background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 15px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--surface-color); border-radius: 16px; box-shadow: 0 8px 30px var(--shadow-color); overflow: hidden; transition: background-color 0.3s; }
        .sticky-bar { position: sticky; background-color: color-mix(in srgb, var(--surface-color) 95%, transparent); backdrop-filter: blur(8px); z-index: 10; padding: 15px 20px; transition: background-color 0.3s, border-color 0.3s; }
        .page-header { top: 0; border-bottom: 1px solid var(--border-color); }
        .page-footer { bottom: 0; border-top: 1px solid var(--border-color); }
        .header-top { display: flex; align-items: center; justify-content: space-between; }
        .header-info { display: flex; align-items: center; }
        .back-button { margin-right: 15px; font-size: 20px; color: var(--text-color); text-decoration: none; }
        #view-title { font-size: 18px; font-weight: 600; color: var(--primary-color); }
        #juz-info { font-size: 14px; color: var(--subtle-text-color); }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .header-actions button { background: none; border: none; font-size: 18px; color: var(--subtle-text-color); cursor: pointer; padding: 5px; }
        .header-actions button.active { color: var(--primary-color); }
        .surah-navigation { display: flex; justify-content: space-between; align-items: center; padding-top: 15px; }
        .surah-nav-button { display: flex; align-items: center; gap: 8px; background-color: var(--background-color); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 20px; text-decoration: none; color: var(--text-color); font-size: 14px; font-weight: 500; }
        .surah-nav-button.disabled { opacity: 0.5; pointer-events: none; }
        .surah-nav-selects { display: flex; gap: 10px; }
        .nav-select { padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-color); font-family: var(--font-latin); font-size: 14px; }
        #loader { text-align: center; padding: 80px 0; }
        .spinner { border: 4px solid rgba(128,128,128,0.2); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); margin: 0 auto 15px; animation: spin 1s ease infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .content { padding: 0 10px 20px 10px; }
        .surah-separator { text-align: center; padding: 30px 20px; margin: 20px 10px; }
        .surah-separator .surah-title-prefix { font-family: var(--font-arabic); font-size: 24px; color: var(--primary-color); }
        .surah-separator .arabic-name { font-family: var(--font-arabic); font-size: 36px; color: var(--primary-color); margin-top: -15px; }
        .surah-separator .latin-name { font-size: 24px; font-weight: 600; margin: 5px 0; }
        .surah-separator .details { font-size: 14px; color: var(--subtle-text-color); text-transform: uppercase; }
        .bismillah-header { font-family: var(--font-arabic); text-align: center; font-size: 24px; padding: 25px 0; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); margin: 20px 0; }
        .verse-item { padding: 25px 0; border-bottom: 1px solid var(--border-color); position: relative; } .verse-item:last-child { border-bottom: none; }
        .verse-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .verse-number-wrapper { width: 40px; height: 40px; background-image: url('https://i.ibb.co/9hNn2y1/ayat-bg.png'); background-size: contain; background-repeat: no-repeat; display: flex; align-items: center; justify-content: center; font-family: var(--font-arabic); font-size: 16px; color: var(--primary-color); }
        .arabic-text { font-family: var(--font-arabic); text-align: right; direction: rtl; margin-bottom: 16px; transition: font-size 0.3s, line-height 0.3s; }
        .font-size-small .arabic-text { font-size: 26px; line-height: 2.0; }
        .font-size-medium .arabic-text { font-size: 30px; line-height: 2.2; }
        .font-size-large .arabic-text { font-size: 34px; line-height: 2.4; }
        .font-size-xl .arabic-text { font-size: 38px; line-height: 2.6; }
        .translation-text { font-size: 15px; line-height: 1.7; color: var(--subtle-text-color); margin-top: 20px; padding-left: 55px; } .translation-text.hidden { display: none; }
        .verse-menu-button { background: none; border: none; font-size: 18px; color: #aaa; cursor: pointer; padding: 10px; position: absolute; top: 15px; left: 0; }
        .verse-menu-popup { display: none; position: absolute; background-color: var(--surface-color); border-radius: 8px; box-shadow: 0 4px 15px var(--shadow-color); z-index: 20; border: 1px solid var(--border-color); overflow: hidden; }
        .verse-menu-popup a { display: flex; align-items: center; padding: 12px 18px; text-decoration: none; color: var(--text-color); font-size: 14px; white-space: nowrap; }
        .verse-menu-popup a i { margin-right: 12px; width: 16px; text-align: center; color: var(--subtle-text-color); }
        .verse-menu-popup a:hover { background-color: var(--background-color); }
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; } .modal.active { display: flex; }
        .modal-content { background-color: var(--surface-color); padding: 0; border-radius: 12px; width: 90%; max-width: 600px; position: relative; animation: slide-down 0.3s ease-out; display: flex; flex-direction: column; max-height: 80vh; }
        @keyframes slide-down { from { transform: translateY(-30px); } to { transform: translateY(0); } }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 18px; }
        .modal-body { padding: 25px; overflow-y: auto; }
        .modal-close { font-size: 28px; cursor: pointer; color: #aaa; }
        .tafsir-tabs { display: flex; border-bottom: 1px solid var(--border-color); padding: 0 25px; }
        .tafsir-tab-btn { background: none; border: none; padding: 10px 15px; font-size: 14px; font-weight: 500; cursor: pointer; color: var(--subtle-text-color); border-bottom: 2px solid transparent; }
        .tafsir-tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tafsir-content { display: none; } .tafsir-content.active { display: block; }
        .tafsir-arabic { font-family: var(--font-arabic); direction: rtl; text-align: right; font-size: 18px; line-height: 1.8; }
        #theme-toggle .fa-moon { display: none; }
        body.dark-mode #theme-toggle .fa-moon { display: inline; }
        body.dark-mode #theme-toggle .fa-sun { display: none; }
    </style>
</head>
<body class="font-size-medium">
<div class="container">
    <header class="page-header sticky-bar">
        <div class="header-top">
            <div class="header-info">
                <a href="home.html" class="back-button"><i class="fas fa-arrow-left"></i></a>
                <div><h1 id="view-title">Memuat...</h1><div id="juz-info"></div></div>
            </div>
            <div class="header-actions">
                <button id="toggle-translation" class="active" title="Tampilkan/Sembunyikan Terjemahan"><i class="fas fa-language"></i></button>
                <button id="font-size-toggle" title="Ubah Ukuran Font"><i class="fas fa-font"></i></button>
                <button id="theme-toggle" title="Ubah Tema"><i class="fas fa-sun"></i><i class="fas fa-moon"></i></button>
            </div>
        </div>
        <div class="surah-navigation">
            <a href="#" id="prev-surah-btn" class="surah-nav-button"><i class="fas fa-chevron-left"></i> <span></span></a>
            <div class="surah-nav-selects">
                <select id="surah-select" class="nav-select"></select>
                <select id="page-select" class="nav-select"></select>
            </div>
            <a href="#" id="next-surah-btn" class="surah-nav-button"><span></span> <i class="fas fa-chevron-right"></i></a>
        </div>
    </header>
    <main>
        <div id="loader"><div class="spinner"></div><span>Memuat data halaman...</span></div>
        <div class="content" id="verse-container" style="display: none;"></div>
    </main>
    <footer class="page-footer sticky-bar">
        <div class="page-navigation">
            <button id="prev-page-btn" class="nav-button">Sebelumnya</button>
            <button id="next-page-btn" class="nav-button">Berikutnya</button>
        </div>
    </footer>
</div>
<div id="tafsir-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="tafsir-title"></h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="tafsir-tabs">
            <button class="tafsir-tab-btn active" data-content="tafsir-id">Indonesia</button>
            <button class="tafsir-tab-btn" data-content="tafsir-ar">العربية</button>
        </div>
        <div class="modal-body">
            <div id="tafsir-id" class="tafsir-content active"></div>
            <div id="tafsir-ar" class="tafsir-content tafsir-arabic"></div>
        </div>
    </div>
</div>
<div class="verse-menu-popup" id="verse-menu">
    <a href="#" id="menu-play-audio"><i class="fas fa-play"></i> Putar Ayat</a>
    <a href="#" id="menu-show-tafsir"><i class="fas fa-book-open"></i> Lihat Tafsir</a>
    <a href="#" id="menu-bookmark"><i class="far fa-star"></i> Simpan ke Bookmark</a>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const QURAN_API_URL = 'https://api.quran.com/api/v4';
    const body = document.body;
    const viewTitle = document.getElementById('view-title');
    const juzInfo = document.getElementById('juz-info');
    const verseContainer = document.getElementById('verse-container');
    const loader = document.getElementById('loader');
    const translationBtn = document.getElementById('toggle-translation');
    const themeToggleBtn = document.getElementById('theme-toggle');
    const fontSizeBtn = document.getElementById('font-size-toggle');
    const modal = document.getElementById('tafsir-modal');
    const verseMenu = document.getElementById('verse-menu');
    const prevSurahBtn = document.getElementById('prev-surah-btn');
    const nextSurahBtn = document.getElementById('next-surah-btn');
    const surahSelect = document.getElementById('surah-select');
    const pageSelect = document.getElementById('page-select');
    const prevPageBtn = document.getElementById('prev-page-btn');
    const nextPageBtn = document.getElementById('next-page-btn');
    let currentPage = 1;
    let chaptersData = null;
    let pageDataCache = {};
    let currentAudio = null;
    let bookmarks = JSON.parse(localStorage.getItem('quranBookmarksV2')) || [];
    const fontSizes = ['medium', 'large', 'xl', 'small'];
    let currentSizeIndex = 0;

    const getUrlParameter = (name) => new URL(window.location.href).searchParams.get(name);

    const fetchAndDisplayPage = async (pageNumber, keepPosition = false) => {
        if (!pageNumber || pageNumber < 1 || pageNumber > 604) return;
        currentPage = parseInt(pageNumber);
        verseContainer.style.display = 'none';
        loader.style.display = 'block';
        if (!keepPosition) {
            if (location.hash) { history.pushState("", document.title, window.location.pathname + window.location.search); }
            window.scrollTo(0, 0);
        }
        if (pageDataCache[currentPage]) {
            displayPageContent(pageDataCache[currentPage]);
            updateSurahNavigation(pageDataCache[currentPage][0].chapter_id);
            return;
        }
        // --- PERBAIKAN: Meminta dua tafsir sekaligus ---
        const params = new URLSearchParams({ language: 'id', translations: 33, tafsirs: '167,161', audio: 7, fields: 'text_uthmani' });
        try {
            const response = await fetch(`${QURAN_API_URL}/verses/by_page/${currentPage}?${params}`);
            if (!response.ok) throw new Error(`Network response error: ${response.status}`);
            const data = await response.json();
            pageDataCache[currentPage] = data.verses;
            displayPageContent(data.verses);
            updateSurahNavigation(data.verses[0].chapter_id);
        } catch (error) {
            verseContainer.innerHTML = `<p style='text-align:center;'>Gagal memuat halaman. Coba refresh.</p>`;
        } finally {
            verseContainer.style.display = 'block';
            loader.style.display = 'none';
        }
    };

    const displayPageContent = (verses) => {
        // ... (fungsi ini tidak berubah signifikan)
        if (!verses || !verses.length) return;
        verseContainer.innerHTML = '';
        let lastSurahId = null;
        const firstVerseOnPage = verses[0];
        const surahIds = [...new Set(verses.map(v => v.chapter_id))];
        viewTitle.textContent = surahIds.map(id => chaptersData.find(c => c.id == id)?.name_simple || '').join(' & ');
        juzInfo.textContent = `Juz ${firstVerseOnPage.juz_number}`;
        
        verses.forEach(verse => {
            if (verse.chapter_id !== lastSurahId) {
                const surahInfo = chaptersData.find(c => c.id === verse.chapter_id);
                if (surahInfo) {
                    verseContainer.innerHTML += displaySurahHeader(surahInfo);
                    if (surahInfo.bismillah_pre) {
                         verseContainer.innerHTML += `<div class="bismillah-header">بِسْمِ ٱللَّهِ ٱلرَّحْمَـٰنِ ٱلرَّحِيمِ</div>`;
                    }
                }
                lastSurahId = verse.chapter_id;
            }
            const verseNumberArabic = new Intl.NumberFormat('ar-EG').format(verse.verse_number);
            verseContainer.innerHTML += `
                <div class="verse-item" id="${verse.verse_key}">
                    <button class="verse-menu-button" data-verse-key="${verse.verse_key}"><i class="fas fa-ellipsis-v"></i></button>
                    <div class="verse-header"><div></div><div class="verse-number-wrapper">${verseNumberArabic}</div></div>
                    <p class="arabic-text">${verse.text_uthmani}</p>
                    <p class="translation-text">${verse.translations[0].text.replace(/<[^>]*>/g, '')}</p>
                </div>`;
        });
        attachActionListeners();
        setInitialTranslationVisibility();
        pageSelect.value = currentPage;
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= 604;
        const hash = window.location.hash.substring(1);
        if (hash) document.getElementById(hash)?.scrollIntoView();
    };

    const displaySurahHeader = (surahInfo) => { /* ... (fungsi ini tidak berubah) ... */ };
    const attachActionListeners = () => { /* ... (fungsi ini tidak berubah) ... */ };
    const openVerseMenu = (button, verseKey) => { /* ... (fungsi ini tidak berubah) ... */ };
    const handleAudio = (verseKey) => { /* ... (fungsi ini tidak berubah) ... */ };
    
    // --- PERBAIKAN UTAMA: Logika Tafsir Multi-Bahasa ---
    const openTafsirModal = (verse) => {
        const surahName = chaptersData.find(c => c.id == verse.chapter_id)?.name_simple || '';
        modal.querySelector('#tafsir-title').textContent = `Tafsir ${surahName} Ayat ${verse.verse_number}`;

        const tafsirIdContent = modal.querySelector('#tafsir-id');
        const tafsirArContent = modal.querySelector('#tafsir-ar');
        
        const tafsirKemenag = verse.tafsirs.find(t => t.id === 167);
        const tafsirJalalayn = verse.tafsirs.find(t => t.id === 161);

        tafsirIdContent.innerHTML = tafsirKemenag ? tafsirKemenag.text : "Tafsir Indonesia tidak tersedia.";
        tafsirArContent.innerHTML = tafsirJalalayn ? tafsirJalalayn.text : "التفسير غير متوفر لهذه الآية.";

        modal.classList.add('active');
    };

    const toggleBookmark = (verseKey) => { /* ... (fungsi ini tidak berubah) ... */ };
    const toggleAllTranslations = () => { /* ... (fungsi ini tidak berubah) ... */ };
    const setInitialTranslationVisibility = () => { /* ... (fungsi ini tidak berubah) ... */ };
    const setTheme = (theme) => { /* ... (fungsi ini tidak berubah) ... */ };
    const setFontSize = (sizeClass) => { /* ... (fungsi ini tidak berubah) ... */ };
    const cycleFontSize = () => { /* ... (fungsi ini tidak berubah) ... */ };
    const populateNavControls = () => { /* ... (fungsi ini tidak berubah) ... */ };
    const updateSurahNavigation = (currentSurahId) => { /* ... (fungsi ini tidak berubah) ... */ };
    const initializePage = async () => { /* ... (fungsi ini tidak berubah) ... */ };
    
    // --- Event Listeners ---
    surahSelect.onchange = () => { window.location.href = `detail.html?surah=${surahSelect.value}`; };
    pageSelect.onchange = () => { fetchAndDisplayPage(pageSelect.value); };
    translationBtn.onclick = toggleAllTranslations;
    fontSizeBtn.onclick = cycleFontSize;
    themeToggleBtn.onclick = () => setTheme(body.classList.contains('dark-mode') ? 'light' : 'dark');
    modal.querySelector('.modal-close').onclick = () => modal.classList.remove('active');
    document.addEventListener('click', (e) => {
        if (!verseMenu.contains(e.target) && !e.target.closest('.verse-menu-button')) {
            verseMenu.style.display = 'none';
        }
    });
    prevPageBtn.onclick = () => fetchAndDisplayPage(currentPage - 1);
    nextPageBtn.onclick = () => fetchAndDisplayPage(currentPage + 1);
    
    // Event listener untuk tab di dalam modal tafsir
    document.querySelectorAll('.tafsir-tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelector('.tafsir-tab-btn.active').classList.remove('active');
            document.querySelector('.tafsir-content.active').classList.remove('active');
            e.currentTarget.classList.add('active');
            document.getElementById(e.currentTarget.dataset.content).classList.add('active');
        });
    });

    const savedTheme = localStorage.getItem('quranTheme') || 'light';
    const savedFontSize = localStorage.getItem('quranFontSize') || 'medium';
    setTheme(savedTheme);
    setFontSize(savedFontSize);

    initializePage();
});
</script>
</body>
</html>
