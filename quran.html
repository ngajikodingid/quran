<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Baca Al-Qur'an - Mushaf Digital</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Amiri+Quran&family=Noto+Sans&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root{
      --primary-color:#2E7D32; --background-color:#F8F9FA; --surface-color:#FFFFFF;
      --text-color:#212529; --subtle-text-color:#6c757d; --border-color:#E9ECEF;
      --font-latin:'Poppins','Noto Sans',sans-serif; --font-arabic:'Amiri Quran',serif;
      --shadow-color:rgba(0,0,0,.08);
    }
    body.dark-mode{
      --primary-color:#66bb6a; --background-color:#121212; --surface-color:#1e1e1e;
      --text-color:#e0e0e0; --subtle-text-color:#9e9e9e; --border-color:#333333;
      --shadow-color:rgba(0,0,0,.2);
    }

    html{ scroll-behavior:smooth; }
    body{
      font-family:var(--font-latin);
      background-color:var(--background-color);
      color:var(--text-color);
      margin:0; padding:15px;
      transition:background-color .3s,color .3s;
    }

    .container{
      max-width:800px; margin:0 auto;
      background-color:var(--surface-color);
      border-radius:16px;
      box-shadow:0 8px 30px var(--shadow-color);
      overflow:hidden; transition:background-color .3s;
      touch-action: pan-y; /* biar swipe horizontal kita handle */
    }

    .sticky-bar{
      position:sticky; z-index:10; padding:12px 16px;
      backdrop-filter:blur(8px);
      transition:background-color .3s, border-color .3s;
      background-color:var(--surface-color);
    }
    @supports (background-color: color-mix(in srgb, #000, #fff)){
      .sticky-bar{ background-color: color-mix(in srgb, var(--surface-color) 95%, transparent); }
    }

    .page-header{ top:0; border-bottom:1px solid var(--border-color); }
    .page-footer{ bottom:0; border-top:1px solid var(--border-color); }

    /* Header grid: kiri / tengah / kanan */
    .header-top{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center; gap:8px;
    }
    .header-left{ justify-self:start; display:flex; align-items:center; }
    .header-actions{ justify-self:end; display:flex; align-items:center; gap:14px; }
    .header-center{ min-width:0; }

    /* Dropdown Surah (elegan) */
    .surah-select-wrap{
      position:relative; width:100%; max-width:360px; margin:0 auto;
    }
    .surah-select{
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      width:100%;
      padding:10px 36px 10px 14px;
      background:var(--background-color);
      border:1px solid var(--border-color);
      border-radius:999px;
      color:var(--primary-color);
      font-weight:600; font-size:15px; text-align:center;
      outline:none; cursor:pointer;
    }
    .surah-select:disabled{ opacity:.7; cursor:not-allowed; }
    .surah-select-wrap .chev{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      pointer-events:none; color:var(--subtle-text-color); font-size:14px;
    }
    .header-center .meta{
      margin-top:6px; font-size:12.5px; color:var(--subtle-text-color); text-align:center; text-transform:capitalize;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .back-button{ font-size:20px; color:var(--text-color); text-decoration:none; padding:6px; }
    .header-actions button{
      background:none; border:none; font-size:18px; color:var(--subtle-text-color);
      cursor:pointer; padding:6px;
    }
    .header-actions button.active{ color:var(--primary-color); }

    #loader{ text-align:center; padding:80px 0; }
    .spinner{ border:4px solid rgba(128,128,128,.2); width:36px; height:36px; border-radius:50%; border-left-color:var(--primary-color); margin:0 auto 15px; animation:spin 1s ease infinite; }
    @keyframes spin{ 100%{ transform:rotate(360deg); } }

    /* ruang untuk sticky footer */
    .content{ padding:0 10px 80px 10px; }

    .bismillah-header{
      font-family:var(--font-arabic); text-align:center; font-size:24px; padding:25px 0;
      border-top:1px solid var(--border-color); border-bottom:1px solid var(--border-color); margin:20px 0;
    }

    .verse-item{ padding:25px 0; border-bottom:1px solid var(--border-color); position:relative; }
    .verse-item:last-child{ border-bottom:none; }

    .verse-header{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; }
    .verse-number-wrapper{
      width:40px; height:40px;
      background-image:url('https://i.ibb.co/pzp553V/ayat-bg-islamic-style-frame-1.png');
      background-size:contain; background-repeat:no-repeat;
      display:flex; align-items:center; justify-content:center;
      font-family:var(--font-arabic); font-size:16px; color:var(--primary-color);
    }

    .arabic-text{
      font-family:var(--font-arabic); text-align:right; direction:rtl; margin-bottom:16px;
      transition:font-size .3s, line-height .3s;
    }

    .font-size-small{ --arabic-font-size:26px; --arabic-line-height:2.0; }
    .font-size-medium{ --arabic-font-size:30px; --arabic-line-height:2.2; }
    .font-size-large{ --arabic-font-size:34px; --arabic-line-height:2.4; }
    .font-size-xl{ --arabic-font-size:38px; --arabic-line-height:2.6; }
    .arabic-text{ font-size:var(--arabic-font-size); line-height:var(--arabic-line-height); }

    .translation-text{ font-size:15px; line-height:1.7; color:var(--subtle-text-color); margin-top:20px; padding-left:55px; }
    .translation-text.hidden{ display:none; }

    .verse-menu-button{
      background:none; border:none; font-size:18px; color:#aaa; cursor:pointer; padding:10px;
      position:absolute; top:15px; left:0;
    }

    /* Popup menu fixed */
    .verse-menu-popup{
      display:none; position:fixed; z-index:200;
      background-color:var(--surface-color);
      border-radius:8px; box-shadow:0 4px 15px var(--shadow-color);
      border:1px solid var(--border-color); overflow:hidden; min-width:180px;
    }
    .verse-menu-popup a{
      display:flex; align-items:center; padding:12px 18px;
      text-decoration:none; color:var(--text-color); font-size:14px; white-space:nowrap;
    }
    .verse-menu-popup a i{ margin-right:12px; width:16px; text-align:center; color:var(--subtle-text-color); }
    .verse-menu-popup a:hover{ background-color:var(--background-color); }

    /* Modal */
    .modal{ position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; }
    .modal.active{ display:flex; }
    .modal-content{ background-color:var(--surface-color); padding:0; border-radius:12px; width:90%; max-width:640px; position:relative; animation:slide-down .3s ease-out; display:flex; flex-direction:column; max-height:80vh; }
    @keyframes slide-down{ from{ transform:translateY(-30px); } to{ transform:translateY(0); } }
    .modal-header{ padding:15px 25px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; }
    .modal-header h3{ margin:0; font-size:18px; }
    .modal-body{ padding:18px 20px 24px; overflow-y:auto; }

    .modal-toolbar{
      display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap;
    }
    .select-ui{
      position:relative; min-width:220px; flex:1;
    }
    .select-ui select{
      width:100%; padding:10px 36px 10px 12px;
      background:var(--background-color); color:var(--text-color);
      border:1px solid var(--border-color); border-radius:10px; outline:none;
      font-size:14px; cursor:pointer;
    }
    .select-ui .chev{
      position:absolute; right:10px; top:50%; transform:translateY(-50%); pointer-events:none; color:var(--subtle-text-color);
    }
    .tafsir-content.arabic{ font-family:var(--font-arabic); direction:rtl; text-align:right; font-size:18px; line-height:1.8; }

    /* Footer nav */
    .page-navigation{ display:flex; justify-content:space-between; align-items:center; }
    .nav-button{ background:none; border:none; font-size:24px; color:var(--text-color); cursor:pointer; padding:10px; }
    .nav-button:disabled{ color:var(--border-color); cursor:not-allowed; }
    .page-number-display{ font-size:14px; color:var(--subtle-text-color); font-weight:500; }

    #theme-toggle .fa-moon{ display:none; }
    body.dark-mode #theme-toggle .fa-moon{ display:inline; }
    body.dark-mode #theme-toggle .fa-sun{ display:none; }
  </style>
</head>
<body class="font-size-medium">
  <div class="container" id="swipe-area">
    <header class="page-header sticky-bar">
      <div class="header-top">
        <div class="header-left">
          <a href="home.html" class="back-button" aria-label="Kembali ke Beranda">
            <i class="fas fa-arrow-left"></i>
          </a>
        </div>

        <!-- TENGAH: Dropdown Surah -->
        <div class="header-center">
          <div class="surah-select-wrap">
            <select id="surah-select" class="surah-select" disabled>
              <option>Memuat…</option>
            </select>
            <i class="fa-solid fa-chevron-down chev" aria-hidden="true"></i>
          </div>
          <div id="surah-info-header" class="meta"></div>
        </div>

        <!-- KANAN: Aksi -->
        <div class="header-actions">
          <button id="toggle-translation" class="active" title="Tampilkan/Sembunyikan Terjemahan">
            <i class="fas fa-language"></i>
          </button>
          <button id="font-size-toggle" title="Ubah Ukuran Font">
            <i class="fas fa-font"></i>
          </button>
          <button id="theme-toggle" title="Ubah Tema">
            <i class="fas fa-sun"></i><i class="fas fa-moon"></i>
          </button>
        </div>
      </div>
    </header>

    <main>
      <div id="loader"><div class="spinner"></div><span>Memuat data halaman...</span></div>
      <div class="content" id="verse-container" style="display:none;"></div>
    </main>

    <footer class="page-footer sticky-bar">
      <div class="page-navigation">
        <!-- (tetap mushaf style tombol) Kiri = Next, Kanan = Previous -->
        <button id="prev-page-btn" class="nav-button" title="Halaman Berikutnya"><i class="fas fa-chevron-left"></i></button>
        <span id="page-number-display" class="page-number-display">Halaman 1</span>
        <button id="next-page-btn" class="nav-button" title="Halaman Sebelumnya"><i class="fas fa-chevron-right"></i></button>
      </div>
    </footer>
  </div>

  <!-- Modal Tafsir -->
  <div id="tafsir-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="tafsir-title">
      <div class="modal-header">
        <h3 id="tafsir-title"></h3>
        <span class="modal-close" role="button" aria-label="Tutup">&times;</span>
      </div>
      <div class="modal-body">
        <div class="modal-toolbar">
          <div class="select-ui">
            <select id="tafsir-select"></select>
            <i class="fa-solid fa-chevron-down chev" aria-hidden="true"></i>
          </div>
          <div class="select-ui">
            <select id="lang-select">
              <option value="id">Bahasa Indonesia</option>
              <option value="ar">Bahasa Arab</option>
              <option value="en">English</option>
            </select>
            <i class="fa-solid fa-chevron-down chev" aria-hidden="true"></i>
          </div>
        </div>
        <div id="tafsir-content" class="tafsir-content"></div>
      </div>
    </div>
  </div>

  <!-- Popup menu ayat -->
  <div class="verse-menu-popup" id="verse-menu">
    <a href="#" id="menu-play-audio"><i class="fas fa-play"></i> Putar Ayat</a>
    <a href="#" id="menu-show-tafsir"><i class="fas fa-book-open"></i> Lihat Tafsir</a>
    <a href="#" id="menu-bookmark"><i class="far fa-star"></i> Simpan ke Bookmark</a>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const QURAN_API_URL = 'https://api.quran.com/api/v4';

      const body = document.body;
      const surahSelect = document.getElementById('surah-select');
      const surahInfoHeader = document.getElementById('surah-info-header');
      const verseContainer = document.getElementById('verse-container');
      const loader = document.getElementById('loader');
      const translationBtn = document.getElementById('toggle-translation');
      const themeToggleBtn = document.getElementById('theme-toggle');
      const fontSizeBtn = document.getElementById('font-size-toggle');
      const modal = document.getElementById('tafsir-modal');
      const verseMenu = document.getElementById('verse-menu');
      const prevPageBtn = document.getElementById('prev-page-btn'); // kiri (Next)
      const nextPageBtn = document.getElementById('next-page-btn'); // kanan (Previous)
      const pageNumberDisplay = document.getElementById('page-number-display');
      const swipeArea = document.getElementById('swipe-area');

      let currentPage = 1;
      let chaptersById = {};
      let chaptersList = [];
      let pageDataCache = {};
      let currentAudio = null;
      let bookmarks = JSON.parse(localStorage.getItem('quranBookmarksV2')) || [];
      const fontSizes = ['medium', 'large', 'xl', 'small'];
      let currentSizeIndex = 0;

      // ===== Tafsir sources (dinamis + fallback) =====
      let tafsirSources = []; // {id, name, lang}
      const fallbackTafsirs = [
        { id: 167, name: 'Kemenag (Ringkas)', lang: 'id' },
        { id: 168, name: 'Kemenag (Lengkap)', lang: 'id' },
        { id: 161, name: 'Al-Jalalayn', lang: 'ar' },
        { id: 14,  name: 'Ibn Kathir', lang: 'ar' },
        { id: 15,  name: 'At-Tabari', lang: 'ar' },
        { id: 91,  name: 'As-Sa\'di', lang: 'ar' },
        { id: 16,  name: 'Al-Muyassar', lang: 'ar' }
      ];

      const getUrlParameter = (name) => new URL(window.location.href).searchParams.get(name);
      const toAbsoluteUrl = (u) => /^https?:\/\//i.test(u) ? u : `https://verses.quran.com/${String(u||'').replace(/^\/+/, '')}`;

      const indexChapters = (chapters) => { chaptersById = {}; chapters.forEach(c => { chaptersById[c.id] = c; }); chaptersList = chapters; };
      const getChapter = (id) => chaptersById[id] || null;

      const ensureChapters = async () => {
        const res = await fetch(`${QURAN_API_URL}/chapters?language=id`);
        if (!res.ok) throw new Error('Gagal mengambil daftar surah');
        const data = await res.json();
        indexChapters(data.chapters || []);
      };

      const populateSurahDropdown = (selectedId) => {
        let html = '';
        chaptersList.forEach(ch => {
          html += `<option value="${ch.id}" ${Number(selectedId)===Number(ch.id)?'selected':''}>
            ${ch.id}. ${ch.name_simple}
          </option>`;
        });
        surahSelect.innerHTML = html;
        surahSelect.disabled = false;
      };

      const updateHeaderMeta = (chInfo) => {
        if (chInfo && chInfo.revelation_place && chInfo.verses_count){
          surahInfoHeader.textContent = `${chInfo.revelation_place} • ${chInfo.verses_count} AYAT`;
        } else {
          surahInfoHeader.textContent = '';
        }
      };

      // ===== Tafsir discovery =====
      const fetchTafsirCatalog = async () => {
        const langs = ['id','ar','en'];
        const map = new Map();
        for (const lang of langs) {
          try {
            const r = await fetch(`${QURAN_API_URL}/tafsirs?language=${lang}`);
            if (!r.ok) continue;
            const list = (await r.json()).tafsirs || [];
            list.forEach(t => {
              // keep unique by id
              if (!map.has(t.id)) map.set(t.id, { id: t.id, name: t.name, lang });
            });
          } catch {}
        }
        // merge fallback to guarantee minimum options
        fallbackTafsirs.forEach(t => { if (!map.has(t.id)) map.set(t.id, t); });
        tafsirSources = Array.from(map.values());
      };

      const fetchPage = async (pageNumber) => {
        const params = new URLSearchParams({
          language: 'id',
          translations: 33,         // Kemenag (id)
          fields: 'text_uthmani',
          audio: 7
        });
        const response = await fetch(`${QURAN_API_URL}/verses/by_page/${pageNumber}?${params}`);
        if (!response.ok) throw new Error(`Network error: ${response.status}`);
        const data = await response.json();
        return data.verses || [];
      };

      const fetchAndDisplayPage = async (pageNumber, keepPosition = false) => {
        if (!pageNumber || pageNumber < 1 || pageNumber > 604) return;
        currentPage = parseInt(pageNumber);
        verseContainer.style.display = 'none';
        loader.style.display = 'block';

        if (!keepPosition) {
          if (location.hash) {
            history.pushState("", document.title, window.location.pathname + window.location.search);
          }
          window.scrollTo(0, 0);
        }

        try {
          const verses = pageDataCache[currentPage] || await fetchPage(currentPage);
          pageDataCache[currentPage] = verses;
          displayPageContent(verses);
        } catch (e) {
          verseContainer.innerHTML = `<p style="text-align:center;">Gagal memuat halaman. Coba refresh.</p>`;
        } finally {
          verseContainer.style.display = 'block';
          loader.style.display = 'none';
        }
      };

      const displayPageContent = (verses) => {
        if (!verses || !verses.length) return;
        verseContainer.innerHTML = '';

        // header: pakai surah dari ayat pertama
        const primarySurahId = Number(verses[0].chapter_id);
        const chInfo = getChapter(primarySurahId);
        // Set dropdown ke surah ini (jika belum sama)
        if (Number(surahSelect.value) !== primarySurahId) {
          surahSelect.value = String(primarySurahId);
        }
        updateHeaderMeta(chInfo);

        // Konten
        let lastSurahId = null;
        verses.forEach(verse => {
          if (verse.chapter_id !== lastSurahId) {
            const info = getChapter(verse.chapter_id);
            if (info && info.bismillah_pre) {
              verseContainer.insertAdjacentHTML('beforeend',
                `<div class="bismillah-header">بِسْمِ ٱللَّهِ ٱلرَّحْمَـٰنِ ٱلرَّحِيمِ</div>`);
            }
            lastSurahId = verse.chapter_id;
          }

          const verseNumberArabic = new Intl.NumberFormat('ar-EG').format(verse.verse_number);
          verseContainer.innerHTML += `
            <div class="verse-item" id="${verse.verse_key}">
              <button class="verse-menu-button" data-verse-key="${verse.verse_key}">
                <i class="fas fa-ellipsis-vertical"></i>
              </button>
              <div class="verse-header">
                <div></div>
                <div class="verse-number-wrapper">${verseNumberArabic}</div>
              </div>
              <p class="arabic-text">${verse.text_uthmani}</p>
              <p class="translation-text">${
                (verse.translations?.[0]?.text || '').replace(/<[^>]*>/g, '')
              }</p>
            </div>`;
        });

        attachActionListeners();
        setInitialTranslationVisibility();

        pageNumberDisplay.textContent = `Halaman ${currentPage}`;
        prevPageBtn.disabled = currentPage >= 604; // kiri = next
        nextPageBtn.disabled = currentPage <= 1;   // kanan = previous

        const hash = window.location.hash.substring(1);
        if (hash) document.getElementById(hash)?.scrollIntoView();
      };

      const attachActionListeners = () => {
        document.querySelectorAll('.verse-menu-button').forEach(button => {
          button.addEventListener('click', (e) => {
            e.stopPropagation();
            openVerseMenu(e.currentTarget, e.currentTarget.dataset.verseKey);
          });
        });
      };

      // Popup fixed
      const openVerseMenu = (button, verseKey) => {
        const verse = pageDataCache[currentPage]?.find(v => v.verse_key === verseKey);
        if (!verse) return;

        document.getElementById('menu-play-audio').onclick = (e) => {
          e.preventDefault();
          handleAudio(verse.audio?.url);
          verseMenu.style.display = 'none';
        };
        document.getElementById('menu-show-tafsir').onclick = (e) => {
          e.preventDefault();
          openTafsirModal(verse);
          verseMenu.style.display = 'none';
        };
        const bookmarkLink = document.getElementById('menu-bookmark');
        const isBookmarked = bookmarks.includes(verseKey);
        bookmarkLink.innerHTML = isBookmarked
          ? `<i class="fas fa-star"></i> Hapus Bookmark`
          : `<i class="far fa-star"></i> Simpan Bookmark`;
        bookmarkLink.onclick = (e) => { e.preventDefault(); toggleBookmark(verseKey); verseMenu.style.display = 'none'; };

        const rect = button.getBoundingClientRect();
        verseMenu.style.display = 'block';

        requestAnimationFrame(() => {
          const menuW = verseMenu.offsetWidth || 200;
          const gap = 12;
          let left = rect.left;
          const overRight = (left + menuW) > (window.innerWidth - gap);
          if (overRight) left = rect.right - menuW;
          left = Math.max(gap, Math.min(left, window.innerWidth - menuW - gap));

          const menuH = verseMenu.offsetHeight || 120;
          let top = rect.bottom + 2;
          if (top + menuH + gap > window.innerHeight) {
            top = Math.max(gap, window.innerHeight - menuH - gap);
          }

          verseMenu.style.left = `${left}px`;
          verseMenu.style.top  = `${top}px`;
          verseMenu.style.right = 'auto';
        });
      };

      const handleAudio = (audioUrl) => {
        if (!audioUrl) return;
        const fullUrl = toAbsoluteUrl(audioUrl);
        if (currentAudio && !currentAudio.paused) {
          currentAudio.pause();
          if (currentAudio.src === fullUrl) { currentAudio = null; return; }
        }
        currentAudio = new Audio(fullUrl);
        currentAudio.play().catch(() => {});
        currentAudio.onended = () => { currentAudio = null; };
      };

      // ===== Tafsir Modal =====
      const langSelect = document.getElementById('lang-select');
      const tafsirSelect = document.getElementById('tafsir-select');
      const tafsirContent = document.getElementById('tafsir-content');

      const openTafsirModal = async (verse) => {
        // Default language follow saved or ID
        const currentLang = localStorage.getItem('tafsirLang') || 'id';
        langSelect.value = currentLang;

        await ensureTafsirOptions(currentLang);
        buildTafsirSelect(currentLang);

        document.getElementById('tafsir-title').textContent =
          `Tafsir Surah ${getChapter(verse.chapter_id)?.name_simple || verse.chapter_id} Ayat ${verse.verse_number}`;

        // load the first option
        if (tafsirSelect.value) {
          displaySelectedTafsir(verse, tafsirSelect.value, currentLang);
        } else {
          tafsirContent.innerHTML = 'Tidak ada tafsir untuk bahasa ini.';
        }

        // events
        langSelect.onchange = async () => {
          localStorage.setItem('tafsirLang', langSelect.value);
          await ensureTafsirOptions(langSelect.value);
          buildTafsirSelect(langSelect.value);
          if (tafsirSelect.value) displaySelectedTafsir(verse, tafsirSelect.value, langSelect.value);
        };
        tafsirSelect.onchange = () => displaySelectedTafsir(verse, tafsirSelect.value, langSelect.value);

        modal.classList.add('active');
      };

      const ensureTafsirOptions = async (lang) => {
        if (!tafsirSources.length) await fetchTafsirCatalog();
        // nothing else needed; we'll filter per lang when building select
      };

      const buildTafsirSelect = (lang) => {
        const list = tafsirSources.filter(t => t.lang === lang);
        tafsirSelect.innerHTML = list.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      };

      const fetchTafsirByAyah = async (verseKey, tafsirId, lang) => {
        const res = await fetch(`${QURAN_API_URL}/tafsirs/${tafsirId}/by_ayah/${verseKey}?language=${lang}`);
        if (!res.ok) throw new Error('Gagal mengambil tafsir');
        const data = await res.json();
        return data.tafsir?.text || '';
      };

      const displaySelectedTafsir = async (verse, tafsirId, lang) => {
        const source = tafsirSources.find(t => t.id == tafsirId);
        tafsirContent.classList.toggle('arabic', (source?.lang || lang) === 'ar');
        tafsirContent.innerHTML = 'Memuat tafsir...';

        try {
          const text = await fetchTafsirByAyah(verse.verse_key, tafsirId, source?.lang || lang || 'id');
          tafsirContent.innerHTML = (text || `Tafsir (${source?.name || 'Terpilih'}) tidak tersedia.`).replace(/\n/g, '<br>');
        } catch {
          tafsirContent.innerHTML = `Tafsir (${source?.name || 'Terpilih'}) tidak tersedia untuk ayat ini.`;
        }
      };

      const toggleBookmark = (verseKey) => {
        const index = bookmarks.indexOf(verseKey);
        if (index > -1) bookmarks.splice(index, 1);
        else bookmarks.push(verseKey);
        localStorage.setItem('quranBookmarksV2', JSON.stringify(bookmarks));
      };

      const toggleAllTranslations = () => {
        translationBtn.classList.toggle('active');
        const show = translationBtn.classList.contains('active');
        document.querySelectorAll('.translation-text').forEach(el => el.classList.toggle('hidden', !show));
      };
      const setInitialTranslationVisibility = () => {
        const show = translationBtn.classList.contains('active');
        document.querySelectorAll('.translation-text').forEach(el => el.classList.toggle('hidden', !show));
      };

      const setTheme = (theme) => {
        body.classList.toggle('dark-mode', theme === 'dark');
        localStorage.setItem('quranTheme', theme);
      };
      const setFontSize = (sizeClass) => {
        ['small','medium','large','xl'].forEach(size => body.classList.remove(`font-size-${size}`));
        body.classList.add(`font-size-${sizeClass}`);
        localStorage.setItem('quranFontSize', sizeClass);
        currentSizeIndex = ['medium','large','xl','small'].indexOf(sizeClass);
      };
      const cycleFontSize = () => {
        const order = ['medium','large','xl','small'];
        currentSizeIndex = (currentSizeIndex + 1) % order.length;
        setFontSize(order[currentSizeIndex]);
      };

      // ===== Init =====
      const initializePage = async () => {
        try {
          await ensureChapters();

          // isi dropdown
          populateSurahDropdown(1);

          // jika ada query surah / juz → kalkulasi page awal
          const surahId = getUrlParameter('surah');
          const juzId = getUrlParameter('juz');
          let startPage = 1;

          if (surahId) {
            const si = getChapter(Number(surahId));
            startPage = si ? si.pages[0] : 1;
          } else if (juzId) {
            const resJuz = await fetch(`${QURAN_API_URL}/juzs/${juzId}`);
            if (!resJuz.ok) throw new Error('Gagal mengambil data juz');
            const juzData = (await resJuz.json()).juz;
            const startingSurah = Object.keys(juzData.verse_mapping)[0];
            const ayatRange = juzData.verse_mapping[startingSurah];
            const startingAyat = String(ayatRange).split('-')[0];
            const fullVerseKey = `${startingSurah}:${startingAyat}`;
            const resVerse = await fetch(`${QURAN_API_URL}/verses/by_key/${fullVerseKey}?fields=page_number`);
            if (!resVerse.ok) throw new Error('Gagal mengambil data halaman ayat');
            startPage = (await resVerse.json()).verse.page_number;
          }

          await fetchAndDisplayPage(startPage);
          // set dropdown to current page's first surah
          const firstV = pageDataCache[startPage]?.[0];
          if (firstV) {
            surahSelect.value = String(firstV.chapter_id);
            updateHeaderMeta(getChapter(Number(firstV.chapter_id)));
          }
        } catch (error) {
          loader.innerHTML = `Gagal memuat data awal.<br><small>${error.message}</small>`;
        }
      };

      // ==== EVENTS ====
      translationBtn.onclick = toggleAllTranslations;
      fontSizeBtn.onclick = cycleFontSize;
      themeToggleBtn.onclick = () => setTheme(body.classList.contains('dark-mode') ? 'light' : 'dark');

      surahSelect.onchange = () => {
        const id = Number(surahSelect.value);
        const info = getChapter(id);
        if (!info) return;
        updateHeaderMeta(info);
        fetchAndDisplayPage(info.pages[0]);
      };

      modal.querySelector('.modal-close').onclick = () => modal.classList.remove('active');
      document.addEventListener('click', (e) => {
        if (!verseMenu.contains(e.target) && !e.target.closest('.verse-menu-button')) {
          verseMenu.style.display = 'none';
        }
      });
      window.addEventListener('scroll', () => { verseMenu.style.display = 'none'; }, { passive:true });

      // Tombol: KIRI = Next (page+1), KANAN = Previous (page-1)
      prevPageBtn.onclick = () => fetchAndDisplayPage(currentPage + 1);
      nextPageBtn.onclick = () => fetchAndDisplayPage(currentPage - 1);

      // Swipe (dibalik): kiri ➜ kanan = Next, kanan ➜ kiri = Previous
      let touchStartX = 0, touchStartY = 0, touchTime = 0;
      const SWIPE_THRESHOLD = 50;   // px
      const SWIPE_TIME = 600;       // ms

      swipeArea.addEventListener('touchstart', (e) => {
        const t = e.changedTouches[0];
        touchStartX = t.pageX;
        touchStartY = t.pageY;
        touchTime = Date.now();
      }, { passive:true });

      swipeArea.addEventListener('touchend', (e) => {
        const t = e.changedTouches[0];
        const dx = t.pageX - touchStartX;
        const dy = t.pageY - touchStartY;
        const dt = Date.now() - touchTime;
        if (dt > SWIPE_TIME) return;
        if (Math.abs(dx) < SWIPE_THRESHOLD || Math.abs(dx) < Math.abs(dy)) return;

        if (dx > 0 && currentPage < 604) {
          // kiri ➜ kanan = Next (page+1)
          fetchAndDisplayPage(currentPage + 1);
        } else if (dx < 0 && currentPage > 1) {
          // kanan ➜ kiri = Previous (page-1)
          fetchAndDisplayPage(currentPage - 1);
        }
      }, { passive:true });

      // preferensi
      const savedTheme = localStorage.getItem('quranTheme') || 'light';
      const savedFontSize = localStorage.getItem('quranFontSize') || 'medium';
      setTheme(savedTheme);
      setFontSize(savedFontSize);

      initializePage();
    });
  </script>
</body>
</html>
